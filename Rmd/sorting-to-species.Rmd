---
title: "Sorting Rockfish To Species"
output: 
  html_notebook:
    toc: true
---


This is a first stab at winnowing down our samples to just a few species of rockfish,
and figuring out which they are.  I am going to go for this with structure.


To start off with, let's load data and libs:
```{r load-stuff}
library(tidyverse)
library(CKMRsim)
library(stringr)

meta <- readRDS("../data/processed/meta-data-tibble.rds")
genos <- readRDS("../extdata/processed/called_genos_na_explicit.rds") %>%
  filter(NMFS_DNA_ID %in% meta$NMFS_DNA_ID)  # drop those we don't have meta data for
samples <- readRDS("../data/processed/sample-sheet-tibble.rds") %>%
  filter(NMFS_DNA_ID %in% meta$NMFS_DNA_ID)
```


## Some initial filters

### Only certain species complexes

Now, get only adults and juveniles of certain species or complexes:
```{r get-spp}
keepers <- meta %>%
  filter(REPORTED_LIFE_STAGE %in% c("ADULT", "JUVENILE") &
           !(SPECIES=="melanops")) %>%
  select(NMFS_DNA_ID) %>%
  unlist() %>% unname()
```

Whittle the genotype data down to just those:
```{r whittle-genos}
kgenos <- genos %>%
  filter(NMFS_DNA_ID %in% keepers)
```

### Take highest read-depth call for multiply-genotyped DNA_IDs

Now, here is a harder operation: if an individual is multiply-genotyped, take the
genotype with the highest total read depth.  
```{r take-just-one}
# slow-ish function to get the total read depth column
tdepth <- function(a, d) {
  if(any(is.na(a))) {
    return(NA)
  }
  if(a[1]==a[2]) {
    return(d[1])
  } else {
    return(d[1] + d[2])
  }
  
}
# this takes the highest read-depth instance of each duplicately-genotyped individual.
geno_one_each <- kgenos %>%
  group_by(NMFS_DNA_ID, locus, gtseq_run, id) %>%
  mutate(total_depth = tdepth(allele, depth)) %>%
  ungroup() %>%
  arrange(NMFS_DNA_ID, locus, total_depth, gtseq_run, id, depth) %>%
  group_by(NMFS_DNA_ID, locus) %>%
  mutate(rank = 1:n()) %>%
  ungroup() %>%
  filter(rank <= 2)
```

### Toss out indivs with fewer than 85 non-missing loci
Now, toss out any individual with fewer than 85 non-missing loci
```{r toss-missers}
no_hi_missers <- geno_one_each %>% 
  group_by(NMFS_DNA_ID) %>%
  filter(sum(!is.na(allele)) >= (85*2))
```
That leaves us with `r length(unique(geno_one_each$NMFS_DNA_ID))` individuals.  Those are the ones that
we will run through structure to identify to species.



## Making a structure data set

We are going to do this by turning alleles into integers and spreading it.  After that we will add 
population identifer integers saying which species think they are.
```{r spread-genos}
# first make integers of the alleles
alle_idxs <- no_hi_missers %>% 
  select(NMFS_DNA_ID, locus, gene_copy, allele) %>%
  group_by(locus) %>%
  mutate(alleidx = as.integer(factor(allele, levels = unique(allele)))) %>%
  ungroup() %>%
  arrange(NMFS_DNA_ID, locus, alleidx)

# then make a space-separated string of the genotype
genostrs <- alle_idxs %>% 
  group_by(NMFS_DNA_ID, locus) %>%
  summarise(genostr = paste(alleidx[1], alleidx[2], collapse = " ")) %>%
  mutate(genostr = ifelse(genostr == "NA NA", "-9 -9", genostr))  # denote missing alleles with -9
  
# finally spread that and we have a data frame that is
# close to final
struct_frame <- genostrs %>%
  tidyr::spread(data = ., key = locus, value = genostr)
  
```


Once we have that, we just need to assign integers to the different groups:
```{r make-group-ints}
tmp <- meta %>%
  filter(NMFS_DNA_ID %in% keepers) %>%
  mutate(group = paste(REPORTED_LIFE_STAGE, SPECIES)) 

groups_list <- tmp %>%
  group_by(group) %>%
  tally() %>% 
  arrange(desc(n)) %>%
  mutate(groupidx = as.integer(factor(group, levels = groups_list$group)) )

group_idx <- tmp %>%
  mutate(groupidx = as.integer(factor(group, levels = groups_list$group)) ) %>%
  select(NMFS_DNA_ID, groupidx)
```

Here is what those group number mean:
```{r show-groups}
groups_list
```

Now we just bung that onto the structure data set and write it out
```{r bung-it-sort}
fstr <- struct_frame %>%
  left_join(., group_idx) %>%
  select(NMFS_DNA_ID, groupidx, everything()) %>%
  arrange(groupidx, NMFS_DNA_ID)

names(fstr)[1:2] <- ""

write.table(fstr, col.names = TRUE, row.names = FALSE, sep = "   ", quote = FALSE, file = "../structure_area/rockfish.txt")
```

It turns out that was a huge waste of time, at least running at K=7 is totally silly. So, I am going to change
direction here and just make a GSI baseline out of the Adults with reasonably high numbers and
then do GSI on the juveniles that are thought to include atrovirens, so I can at least get the kelp
rockfish.

```{r go-for-gsi}
group_idx
```

